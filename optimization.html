<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Optimization &mdash; pySODM  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Speeding up models" href="speedup.html" />
    <link rel="prev" title="Models" href="models.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            pySODM
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="workflow.html">Modeling and calibration workflow</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Case studies</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="enzyme_kinetics.html">Enzyme kinetics</a></li>
<li class="toctree-l1"><a class="reference internal" href="influenza_1718.html">Influenza 2017-2018</a></li>
<li class="toctree-l1"><a class="reference internal" href="references.html">Additional references</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="models.html">Models</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Optimization</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#objective-functions-py">objective_functions.py</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#log-posterior-probability">Log posterior probability</a></li>
<li class="toctree-l3"><a class="reference internal" href="#log-likelihood">Log likelihood</a></li>
<li class="toctree-l3"><a class="reference internal" href="#log-prior-probability">Log prior probability</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#nelder-mead-py">nelder_mead.py</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pso-py">pso.py</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mcmc-py">mcmc.py</a></li>
<li class="toctree-l2"><a class="reference internal" href="#utils-py">utils.py</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="speedup.html">Speeding up models</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="start_to_collaborate.html">Start to collaborate</a></li>
<li class="toctree-l1"><a class="reference internal" href="guidelines.html">Contribution guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="git_workflow.html">Git workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">pySODM</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Optimization</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/optimization.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="optimization">
<h1>Optimization<a class="headerlink" href="#optimization" title="Permalink to this heading">¶</a></h1>
<section id="objective-functions-py">
<h2>objective_functions.py<a class="headerlink" href="#objective-functions-py" title="Permalink to this heading">¶</a></h2>
<section id="log-posterior-probability">
<h3>Log posterior probability<a class="headerlink" href="#log-posterior-probability" title="Permalink to this heading">¶</a></h3>
<p><strong><em>class</em> log_posterior_probability(model, parameter_names, bounds, data, states, log_likelihood_fnc, log_likelihood_fnc_args, weights=None, log_prior_prob_fnc=None, log_prior_prob_fnc_args=None, initial_states=None, aggregation_function=None, labels=None)</strong></p>
<p><strong>Parameters:</strong></p>
<ul class="simple">
<li><p><strong>model</strong> (object) - An initialized ODEModel or SDEModel.</p></li>
<li><p><strong>parameter_names</strong> (list) - Names of model parameters (type: str) to calibrate. Model parameters must be of type float (0D), list containing float (1D), or np.ndarray (nD).</p></li>
<li><p><strong>bounds</strong> (list) - Lower and upper bound of calibrated parameters provided as lists/tuples containing lower and upper bound: example: <code class="docutils literal notranslate"><span class="pre">[(lb_1,</span> <span class="pre">ub_1),</span> <span class="pre">...,</span> <span class="pre">(lb_n,</span> <span class="pre">ub_n)]</span></code>. Values falling outside these bounds will be restricted to the provided ranges before simulating the model.</p></li>
<li><p><strong>data</strong> (list) - Contains the datasets (type: pd.Series/pd.DataFrame) the model should be calibrated to. For one dataset use <code class="docutils literal notranslate"><span class="pre">[dataset,]</span></code>. Must contain a time index named <code class="docutils literal notranslate"><span class="pre">time</span></code> or <code class="docutils literal notranslate"><span class="pre">date</span></code>. Additional axes must be implemented using a <code class="docutils literal notranslate"><span class="pre">pd.Multiindex</span></code> and must bear the names/contain the coordinates of a valid model dimension.</p></li>
<li><p><strong>states</strong> (list) - Names of the model states (type: str) the respective datasets should be matched to.</p></li>
<li><p><strong>log_likelihood_fnc</strong> (list) - Contains a log likelihood function for every provided dataset.</p></li>
<li><p><strong>log_likelihood_fnc_args</strong> (list) - Contains the arguments of the log likelihood functions. If the log likelihood function has no arguments (<code class="docutils literal notranslate"><span class="pre">ll_poisson</span></code>), provide an empty list.</p></li>
<li><p><strong>weights</strong> (list) - optional - Contains the weights of every dataset in the final log posterior probability. Defaults to one for every dataset.</p></li>
<li><p><strong>log_prior_prob_fnc</strong> (list) - optional - Contains a prior probability function for every calibrated parameter. Defaults to a uniform prior using the provided bounds.</p></li>
<li><p><strong>log_prior_prob_fnc_args</strong> (list) - optional - Contains the arguments of the provided prior probability functions.</p></li>
<li><p><strong>initial_states</strong> (list) - optional - Contains a dictionary of initial states for every dataset.</p></li>
<li><p><strong>aggregation_function</strong> (callable function or list) - optional - A user-defined function to manipulate the model output before matching it to data. The function takes as input an <code class="docutils literal notranslate"><span class="pre">xarray.DataArray</span></code>, resulting from selecting the simulation output at the state we wish to match to the dataset (<code class="docutils literal notranslate"><span class="pre">model_output_xarray_Dataset['state_name']</span></code>), as its input. The output of the function must also be an <code class="docutils literal notranslate"><span class="pre">xarray.DataArray</span></code>. No checks are performed on the input or output of the aggregation function, use at your own risk. Illustrative use case: I have a spatially explicit epidemiological model and I desire to simulate it a high spatial resolutioni. However, data is only available on a lower level of spatial resolution. Hence, I use an aggregation function to properly aggregate the spatial levels. I change the coordinates on the spatial dimensions in the model output. Valid inputs for the argument <code class="docutils literal notranslate"><span class="pre">aggregation_function</span></code>are: 1) one callable function –&gt; applied to every dataset. 2) A list containing one callable function –&gt; applied to every dataset. 3) A list containing a callable function for every dataset –&gt; every dataset has its own aggregation function.</p></li>
<li><p><strong>labels</strong> (list) - optional - Contains a custom label for the calibrated parameters. Defaults to the names provided in <code class="docutils literal notranslate"><span class="pre">parameter_names</span></code>.</p></li>
</ul>
<p><strong>Methods:</strong></p>
<ul>
<li><p><strong><strong>call</strong>(thetas, simulation_kwargs={})</strong></p>
<p><strong>Parameters:</strong></p>
<ul class="simple">
<li><p><strong>thetas</strong> (list/np.ndarray) - A flattened list containing the estimated parameter values.</p></li>
<li><p><strong>simulation_kwargs</strong> (dict) - Optional arguments to be passed to the model’s <a class="reference internal" href="models.html"><span class="std std-doc">sim()</span></a> function when evaluating the posterior probability.</p></li>
</ul>
<p><strong>Returns:</strong></p>
<ul class="simple">
<li><p><strong>lp</strong> (float) - Logarithm of the posterior probability.</p></li>
</ul>
</li>
</ul>
</section>
<section id="log-likelihood">
<h3>Log likelihood<a class="headerlink" href="#log-likelihood" title="Permalink to this heading">¶</a></h3>
<p><strong><em>function</em> ll_gaussian(ymodel, ydata, sigma)</strong></p>
<blockquote>
<div><p><strong>Parameters:</strong></p>
<ul class="simple">
<li><p><strong>ymodel</strong> (list/np.ndarray) - Mean values of the Gaussian distribution (i.e. “mu” values), as predicted by the model</p></li>
<li><p><strong>ydata</strong> (list/np.ndarray) - Data time series values to be matched with the model predictions.</p></li>
<li><p><strong>sigma</strong> (float/list of floats/np.ndarray) - Standard deviation(s) of the Gaussian distribution around the data ‘ydata’. Two options are possible: 1) One error per model dimension, applied uniformly to all datapoints corresponding to that dimension; OR 2) One error for every datapoint, corresponding to a weighted least-squares regression.</p></li>
</ul>
</div></blockquote>
<blockquote>
<div><p><strong>Returns:</strong></p>
<ul class="simple">
<li><p><strong>ll</strong> (float) - Loglikelihood associated with the comparison of the data points and the model prediction.</p></li>
</ul>
</div></blockquote>
<blockquote>
<div><p><strong><em>function</em> ll_poisson(ymodel, ydata)</strong></p>
</div></blockquote>
<blockquote>
<div><p><strong>Parameters:</strong></p>
<ul class="simple">
<li><p><strong>ymodel</strong> (list/np.ndarray) - Mean values of the Poisson distribution (i.e. “lambda” values), as predicted by the model.</p></li>
<li><p><strong>ydata</strong> (list/np.ndarray) - Data time series values to be matched with the model predictions.</p></li>
</ul>
</div></blockquote>
<blockquote>
<div><p><strong>Returns:</strong></p>
<ul class="simple">
<li><p><strong>ll</strong> (float) - Loglikelihood associated with the comparison of the data points and the model prediction.</p></li>
</ul>
</div></blockquote>
<p><strong><em>function</em> ll_negative_binomial(ymodel, ydata, alpha)</strong></p>
<blockquote>
<div><p><strong>Parameters:</strong></p>
<ul class="simple">
<li><p><strong>ymodel</strong> (list/np.ndarray) - Mean values of the Negative Binomial distribution, as predicted by the model.</p></li>
<li><p><strong>ydata</strong> (list/np.ndarray) - Data time series values to be matched with the model predictions.</p></li>
<li><p><strong>alpha</strong> (float/list) - Dispersion. Must be positive. If alpha goes to zero, the negative binomial distribution converges to the poisson distribution.</p></li>
</ul>
</div></blockquote>
<blockquote>
<div><p><strong>Returns:</strong></p>
<ul class="simple">
<li><p><strong>ll</strong> (float) - Loglikelihood associated with the comparison of the data points and the model prediction.</p></li>
</ul>
</div></blockquote>
</section>
<section id="log-prior-probability">
<h3>Log prior probability<a class="headerlink" href="#log-prior-probability" title="Permalink to this heading">¶</a></h3>
<p><strong><em>function</em> log_prior_uniform(x, bounds)</strong></p>
<blockquote>
<div><p>Uniform log prior distribution.</p>
</div></blockquote>
<blockquote>
<div><p><strong>Parameters:</strong></p>
</div></blockquote>
<blockquote>
<div><ul class="simple">
<li><p><strong>x</strong> (float) - Parameter value whos probability we want to test.</p></li>
<li><p><strong>bounds</strong> (tuple) - Contains the upper and lower bounds of the parameter value.</p></li>
</ul>
</div></blockquote>
<blockquote>
<div><p><strong>Returns:</strong></p>
<ul class="simple">
<li><p><strong>lp</strong> (float) Log probability of sample x in light of a uniform prior distribution.</p></li>
</ul>
</div></blockquote>
<p><strong><em>function</em> log_prior_custom(x, args)</strong></p>
<blockquote>
<div><p>Computes the probability of a sample in light of a list containing samples.</p>
</div></blockquote>
<blockquote>
<div><p><strong>Parameters:</strong></p>
<ul class="simple">
<li><p><strong>x</strong> (float) - Parameter value whos probability we want to test.</p></li>
<li><p><strong>args</strong> (tuple) - Contains the density of each bin in the first position and the bounds of the bins in the second position. Contains a weight given to the custom prior in the third position of the tuple.</p></li>
</ul>
</div></blockquote>
<blockquote>
<div><p><strong>Returns:</strong></p>
<ul class="simple">
<li><p><strong>lp</strong> (float) Log probability of sample x in light of a custom prior distribution.</p></li>
</ul>
</div></blockquote>
<blockquote>
<div><p><strong>Example use:</strong></p>
</div></blockquote>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">density_my_par</span><span class="p">,</span> <span class="n">bins_my_par</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">([</span><span class="n">sample_0</span><span class="p">,</span> <span class="n">sample_1</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">sample_n</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">density_my_par_norm</span> <span class="o">=</span> <span class="n">density_my_par</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">density_my_par</span><span class="p">)</span>
<span class="n">prior_fcn</span> <span class="o">=</span> <span class="n">prior_custom</span>
<span class="n">prior_fcn_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">density_my_par_norm</span><span class="p">,</span> <span class="n">bins_my_par</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<p><strong><em>function</em> log_prior_normal(x, norm_pars)</strong></p>
<blockquote>
<div><p>Normal log prior distribution.</p>
</div></blockquote>
<blockquote>
<div><p><strong>Parameters:</strong></p>
<ul class="simple">
<li><p><strong>x</strong> (float) - Parameter value whos probability we want to test.</p></li>
<li><p><strong>norm_pars</strong> (tuple) - Tuple containg average and standard deviation of normal distribution.</p></li>
</ul>
</div></blockquote>
<blockquote>
<div><p><strong>Returns:</strong></p>
<ul class="simple">
<li><p><strong>lp</strong> (float) Log probability of sample x in light of a normal prior distribution.</p></li>
</ul>
</div></blockquote>
<p><strong><em>function</em> log_prior_triangle(x, triangle_pars)</strong></p>
<blockquote>
<div><p>Triangular log prior distribution.</p>
</div></blockquote>
<blockquote>
<div><p><strong>Parameters:</strong></p>
<ul class="simple">
<li><p><strong>x</strong> (float) - Parameter value whos probability we want to test.</p></li>
<li><p><strong>triangle_pars</strong> (tuple) - Tuple containg lower bound, upper bound and mode of the triangle distribution.</p></li>
</ul>
</div></blockquote>
<blockquote>
<div><p><strong>Returns:</strong></p>
<ul class="simple">
<li><p><strong>lp</strong> (float) Log probability of sample x in light of a triangular prior distribution.</p></li>
</ul>
</div></blockquote>
<p><strong><em>function</em> log_prior_gamma(x, gamma_pars)</strong></p>
<blockquote>
<div><p>Gamma log prior distribution.</p>
</div></blockquote>
<blockquote>
<div><p><strong>Parameters:</strong></p>
<ul class="simple">
<li><p><strong>x</strong> (float) - Parameter value whos probability we want to test.</p></li>
<li><p><strong>gamma_pars</strong> (tuple) - Tuple containg gamma parameters alpha and beta.</p></li>
</ul>
</div></blockquote>
<blockquote>
<div><p><strong>Returns:</strong></p>
<ul class="simple">
<li><p><strong>lp</strong> (float) Log probability of sample x in light of a gamma prior distribution.</p></li>
</ul>
</div></blockquote>
<p><strong><em>function</em> log_prior_weibull(x, weibull_params)</strong></p>
<blockquote>
<div><p>Weibull log prior distribution.</p>
</div></blockquote>
<blockquote>
<div><p><strong>Parameters:</strong></p>
<ul class="simple">
<li><p><strong>x</strong> (float) - Parameter value whos probability we want to test.</p></li>
<li><p><strong>weibull_params</strong> (tuple) - Contains the weibull parameters k and lambda.</p></li>
</ul>
</div></blockquote>
<blockquote>
<div><p><strong>Returns:</strong></p>
<ul class="simple">
<li><p><strong>lp</strong> (float) Log probability of sample x in light of a weibull prior distribution.</p></li>
</ul>
</div></blockquote>
</section>
</section>
<section id="nelder-mead-py">
<h2>nelder_mead.py<a class="headerlink" href="#nelder-mead-py" title="Permalink to this heading">¶</a></h2>
<p><strong><em>function</em> optimize(func, x_start, step, bounds=None, args=(), kwargs={}, processes=1, no_improve_thr=1e-6, no_improv_break=100, max_iter=1000, alpha=1., gamma=2., rho=-0.5, sigma=0.5)</strong></p>
<blockquote>
<div><p>Perform a <a class="reference external" href="https://en.wikipedia.org/wiki/Nelder%E2%80%93Mead_method">Nelder-Mead minimization</a>.</p>
</div></blockquote>
<blockquote>
<div><p><strong>Parameters:</strong></p>
<ul class="simple">
<li><p><strong>func</strong> (function) - Callable function or class representing the objective function to be minimized. Recommended <code class="docutils literal notranslate"><span class="pre">log_posterior_probability</span></code>.</p></li>
<li><p><strong>x_start</strong> (list or 1D np.ndarray) - Starting estimate for the search algorithm. Length must equal the number of provided bounds.</p></li>
<li><p><strong>step</strong> (list or 1D np.ndarray) - (Relative) size of the initial search simplex.</p></li>
<li><p><strong>bounds</strong> (list) - optional - The bounds of the design variable(s). In form <code class="docutils literal notranslate"><span class="pre">[(lb_1,</span> <span class="pre">ub_1),</span> <span class="pre">...,</span> <span class="pre">(lb_n,</span> <span class="pre">ub_n)]</span></code>. If class <code class="docutils literal notranslate"><span class="pre">log_posterior_probability</span></code> is used as <code class="docutils literal notranslate"><span class="pre">func</span></code>, it already contains bounds. If bounds are provided these will overwrite the bounds available in the ‘log_posterior_probability’ object.</p></li>
<li><p><strong>args</strong> (tuple) - optional - Additional arguments passed to objective function.</p></li>
<li><p><strong>kwargs</strong> (dict) - optional - Additional keyworded arguments passed to objective function. Example use: To compute our log posterior probability (class <code class="docutils literal notranslate"><span class="pre">log_posterior_probability</span></code>) with the ‘RK45’ method, we must change the <code class="docutils literal notranslate"><span class="pre">method</span></code> argument of the <code class="docutils literal notranslate"><span class="pre">sim</span></code> function, which is called in <code class="docutils literal notranslate"><span class="pre">log_posterior_probability</span></code>. To achieve this, we can supply the keyworded argument <code class="docutils literal notranslate"><span class="pre">simulation_kwargs</span></code> of <code class="docutils literal notranslate"><span class="pre">log_posterior_probability</span></code>, which passes its arguments on to the <code class="docutils literal notranslate"><span class="pre">sim</span></code> function. To this end, use <code class="docutils literal notranslate"><span class="pre">kwargs={'simulation_kwargs':{'method':</span> <span class="pre">'RK45'}}</span></code>.</p></li>
<li><p><strong>processes</strong> (int) - optional - Number of cores to use.</p></li>
</ul>
</div></blockquote>
<blockquote>
<div><p><strong>Hyperparameters:</strong></p>
<ul class="simple">
<li><p><strong>no_improve_thr</strong> (float) - optional - Threshold relative iteration-to-iteration objective function value change to label the iteration as having no improvement.</p></li>
<li><p><strong>no_improv_break</strong> (int) - optional - Break after <code class="docutils literal notranslate"><span class="pre">no_improv_break</span></code> iterations without improvement.</p></li>
<li><p><strong>max_iter</strong> (int) - optional - Maximum number of iterations.</p></li>
<li><p><strong>alpha</strong> (float) - optional - Reflection coefficient</p></li>
<li><p><strong>gamma</strong> (float) - optional - Expansion coefficient</p></li>
<li><p><strong>rho</strong> (float) - optional - Contraction coefficient</p></li>
<li><p><strong>sigma</strong> (float) - optional - Shrink coefficient</p></li>
</ul>
</div></blockquote>
<blockquote>
<div><p><strong>Returns:</strong></p>
<ul class="simple">
<li><p><strong>theta</strong> (list) - Position 0: Estimated parameters. Position 1: corresponding score of <code class="docutils literal notranslate"><span class="pre">func</span></code>.</p></li>
</ul>
</div></blockquote>
</section>
<section id="pso-py">
<h2>pso.py<a class="headerlink" href="#pso-py" title="Permalink to this heading">¶</a></h2>
<p><strong><em>function</em> optimize(func, bounds=None, ieqcons=[], f_ieqcons=None, args=(), kwargs={}, processes=1, swarmsize=100, max_iter=100, minstep=1e-12, minfunc=1e-12, omega=0.8, phip=0.8, phig=0.8,  debug=False, particle_output=False, transform_pars=None)</strong></p>
<blockquote>
<div><p>Perform a <a class="reference external" href="https://en.wikipedia.org/wiki/Particle_swarm_optimization">Particle Swarm Optimization</a>. If a PSO with more options is desired, coupling to <a class="reference external" href="https://pyswarms.readthedocs.io/en/latest/examples/tutorials/basic_optimization.html#Optimizing-a-function">pySwarms</a> is straightforward.</p>
</div></blockquote>
<blockquote>
<div><p><strong>Parameters:</strong></p>
<ul class="simple">
<li><p><strong>func</strong> (function) - Callable function or class representing the objective function to be minimized. Recommended <code class="docutils literal notranslate"><span class="pre">log_posterior_probability</span></code>.</p></li>
<li><p><strong>bounds</strong> (list) - optional - The bounds of the design variable(s). In form <code class="docutils literal notranslate"><span class="pre">[(lb_1,</span> <span class="pre">ub_1),</span> <span class="pre">...,</span> <span class="pre">(lb_n,</span> <span class="pre">ub_n)]</span></code>. If class <code class="docutils literal notranslate"><span class="pre">log_posterior_probability</span></code> is used as <code class="docutils literal notranslate"><span class="pre">func</span></code>, it already contains bounds. If bounds are provided these will overwrite the bounds available in the ‘log_posterior_probability’ object.</p></li>
<li><p><strong>ieqcons</strong> (list) - A list of functions of length n such that <code class="docutils literal notranslate"><span class="pre">ieqcons[j](x,*args)</span> <span class="pre">&gt;=</span> <span class="pre">0.0</span></code> in a successfully optimized problem</p></li>
<li><p><strong>f_ieqcons</strong> (function) - Returns a 1-D array in which each element must be greater or equal to 0.0 in a successfully optimized problem. If f_ieqcons is specified, ieqcons is ignored</p></li>
<li><p><strong>args</strong> (tuple) - optional - Additional arguments passed to objective function.</p></li>
<li><p><strong>kwargs</strong> (dict) - optional - Additional keyworded arguments passed to objective function. Example use: To compute our log posterior probability (class <code class="docutils literal notranslate"><span class="pre">log_posterior_probability</span></code>) with the ‘RK45’ method, we must change the <code class="docutils literal notranslate"><span class="pre">method</span></code> argument of the <code class="docutils literal notranslate"><span class="pre">sim</span></code> function, which is called in <code class="docutils literal notranslate"><span class="pre">log_posterior_probability</span></code>. To achieve this, we can supply the keyworded argument <code class="docutils literal notranslate"><span class="pre">simulation_kwargs</span></code> of <code class="docutils literal notranslate"><span class="pre">log_posterior_probability</span></code>, which passes its arguments on to the <code class="docutils literal notranslate"><span class="pre">sim</span></code> function. To this end, use <code class="docutils literal notranslate"><span class="pre">kwargs={'simulation_kwargs':{'method':</span> <span class="pre">'RK45'}}</span></code>.</p></li>
<li><p><strong>processes</strong> (int) - optional - Number of cores to use.</p></li>
</ul>
</div></blockquote>
<blockquote>
<div><p><strong>Hyperparameters:</strong></p>
<ul class="simple">
<li><p><strong>swarmsize</strong> (int) - optional - Size of the swarm. “Number of particles”</p></li>
<li><p><strong>max_iter</strong> (int) - optional - Maximum number of iterations</p></li>
<li><p><strong>minstep</strong> (float) - optional - The minimum stepsize of swarm’s best position before the search terminates</p></li>
<li><p><strong>minfunc</strong> (float) - optional - The minimum change of swarm’s best objective value before the search terminates</p></li>
<li><p><strong>omega</strong> (float) - optional - Inertia weight. Must be smaller than one.</p></li>
<li><p><strong>phip</strong> (float) - optional - Tendency to search away from the particles best known position.  A higher value means each particle has less confidence in it’s own best value.</p></li>
<li><p><strong>phig</strong> (float) - optional - Tendency to search away from the swarm’s best known position. A higher value means each particle has less confidence in the swarm’s best value.</p></li>
<li><p><strong>debug</strong> (bool) - optional - If True, progress statements will be displayed every iteration</p></li>
<li><p><strong>particle_output</strong> (bool) - optional - If True, function additionally returns the best particles position and objective function score</p></li>
<li><p><strong>transform_pars</strong> (func) - optional - Transform the parameter values. E.g. to integer values or to map to a list of possibilities</p></li>
</ul>
</div></blockquote>
<blockquote>
<div><p><strong>Returns:</strong></p>
<ul class="simple">
<li><p><strong>theta</strong> (list) - Position 0: Estimated parameters. Position 1: Corresponding score of <code class="docutils literal notranslate"><span class="pre">func</span></code>. If <code class="docutils literal notranslate"><span class="pre">particle_output==True</span></code> then: Position 3: The best known position per particle. Position 4: Vorresponding score of <code class="docutils literal notranslate"><span class="pre">func</span></code>.</p></li>
</ul>
</div></blockquote>
</section>
<section id="mcmc-py">
<h2>mcmc.py<a class="headerlink" href="#mcmc-py" title="Permalink to this heading">¶</a></h2>
<p><strong><em>function</em> run_EnsembleSampler(pos, max_n, identifier, objective_function, objective_function_args=None, objective_function_kwargs=None, moves=[(emcee.moves.DEMove(), 0.5),(emcee.moves.KDEMove(bw_method=’scott’), 0.5)], fig_path=None, samples_path=None, print_n=10, backend=None, processes=1, progress=True, settings_dict={})</strong></p>
<blockquote>
<div><p>Wrapper function to setup an <code class="docutils literal notranslate"><span class="pre">emcee.EnsembleSampler</span></code> and handle all backend-related tasks.</p>
</div></blockquote>
<blockquote>
<div><p><strong>Parameters:</strong></p>
<ul class="simple">
<li><p><strong>pos</strong> (np.ndarray) - Starting position of the Markov Chains. We recommend using <code class="docutils literal notranslate"><span class="pre">perturbate_theta()</span></code>.</p></li>
<li><p><strong>max_n</strong> (int) - Maximum number of iterations.</p></li>
<li><p><strong>identifier</strong> (str) - Identifier of the expirement.</p></li>
<li><p><strong>objective_function</strong> (callable function) - Objective function. Recommended <code class="docutils literal notranslate"><span class="pre">log_posterior_probability</span></code>.</p></li>
<li><p><strong>objective_function_args</strong> (tuple) - optional - Arguments of the objective function. If using <code class="docutils literal notranslate"><span class="pre">log_posterior_probability</span></code> as objective function, use default <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p></li>
<li><p><strong>objective_function_kwargs</strong> (dict) - optional - Keyworded arguments of the objective function. If using <code class="docutils literal notranslate"><span class="pre">log_posterior_probability</span></code> as objective function, use default <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p></li>
<li><p><strong>fig_path</strong> (str) - optional - Location where the diagnostic figures (autocorrelation and trace plot) are saved.</p></li>
<li><p><strong>samples_path</strong> (str) - optional - Location where the <code class="docutils literal notranslate"><span class="pre">.hdf5</span></code> backend and settings <code class="docutils literal notranslate"><span class="pre">.json</span></code> should be saved.</p></li>
<li><p><strong>print_n</strong> (int) - optional - Print autocorrelation and trace plots every <code class="docutils literal notranslate"><span class="pre">print_n</span></code> iterations.</p></li>
<li><p><strong>processes</strong> (int) - optional - Number of cores to use.</p></li>
<li><p><strong>settings_dict</strong> (dict) - optional - Dictionary containing calibration settings or other usefull settings for long-term storage. Saved in <code class="docutils literal notranslate"><span class="pre">.json</span></code> format. Appended to the samples dictionary generated by <code class="docutils literal notranslate"><span class="pre">emcee_sampler_to_dictionary()</span></code>.</p></li>
</ul>
</div></blockquote>
<blockquote>
<div><p><strong>Hyperparameters:</strong></p>
<ul class="simple">
<li><p><strong>moves</strong> (list) - optional - Consult the <a class="reference external" href="https://emcee.readthedocs.io/en/stable/user/moves/">emcee documentation</a>.</p></li>
<li><p><strong>backend</strong> (<code class="docutils literal notranslate"><span class="pre">emcee.backends.HDFBackend</span></code>) - optional - Backend of a previous sampling experiment. If a backend is provided, the sampler is restarted from the last iteration of the previous run. Consult the <a class="reference external" href="https://emcee.readthedocs.io/en/stable/user/backends/">emcee documentation</a>.</p></li>
<li><p><strong>progress</strong> (bool) - optional - Enables the progress bar.</p></li>
</ul>
</div></blockquote>
<blockquote>
<div><p><strong>Returns:</strong></p>
<ul class="simple">
<li><p><strong>sampler</strong> (<code class="docutils literal notranslate"><span class="pre">emcee.EnsembleSampler</span></code>) - Emcee sampler object (<a class="reference external" href="https://emcee.readthedocs.io/en/stable/user/sampler/">see</a>). To extract a dictionary of samples + settings, use <code class="docutils literal notranslate"><span class="pre">emcee_sampler_to_dictionary</span></code>.</p></li>
</ul>
</div></blockquote>
<p><strong><em>function</em> perturbate_theta(theta, pert, multiplier=2, bounds=None, verbose=None)</strong></p>
<blockquote>
<div><p>A function to perturbate a NM/PSO estimate and construct a matrix with initial positions for the MCMC chains</p>
</div></blockquote>
<blockquote>
<div><p><strong>Parameters:</strong></p>
<ul class="simple">
<li><p><strong>theta</strong> (list or 1D np.ndarray) - List containing the parameter values to be perturbated.</p></li>
<li><p><strong>pert</strong> (list) - Relative perturbation per parameter in <code class="docutils literal notranslate"><span class="pre">theta</span></code>. Drawn from a uniform distribution (plus-minus pert).</p></li>
<li><p><strong>multiplier</strong> (int) - optional - Multiplier determining the total number of markov chains that will be run by <code class="docutils literal notranslate"><span class="pre">emcee</span></code>. Typically, total nr. chains = multiplier * nr. parameters. Minimum is two, at least five recommended.</p></li>
<li><p><strong>bounds</strong> (list) - optional - Lower and upper bound of calibrated parameters provided as tuples. <code class="docutils literal notranslate"><span class="pre">[(lb_1,</span> <span class="pre">ub_1),</span> <span class="pre">...,</span> <span class="pre">(lb_n,</span> <span class="pre">ub_n)]</span></code>. Note: bounds must not be zero, because the perturbation is based on a percentage of the value, and any percentage of zero returns zero, causing an error regarding linear dependence of walkers.</p></li>
<li><p><strong>verbose</strong> (bool) - optional - Print user feedback to stdout</p></li>
</ul>
</div></blockquote>
<blockquote>
<div><p><strong>Returns:</strong></p>
<ul class="simple">
<li><p><strong>ndim</strong> (int) - Number of parameters. Equal to <code class="docutils literal notranslate"><span class="pre">len(theta)</span></code>.</p></li>
<li><p><strong>nwalkers</strong> (int) - Number of Markov chains.</p></li>
<li><p><strong>pos</strong> (np.ndarray) - Initial positions of the Markov chains. Dimensions: <code class="docutils literal notranslate"><span class="pre">[ndim,</span> <span class="pre">nwalkers]</span></code>.</p></li>
</ul>
</div></blockquote>
<p><strong><em>function</em> emcee_sampler_to_dictionary(samples_path, identifier, discard=0, thin=1, run_date=str(datetime.date.today()))</strong></p>
<blockquote>
<div><p>A function to discard and thin the samples available in the <code class="docutils literal notranslate"><span class="pre">emcee</span></code> sampler object and subsequently convert them to a dictionary of format: <code class="docutils literal notranslate"><span class="pre">{parameter_name:</span> <span class="pre">[sample_0,</span> <span class="pre">...,</span> <span class="pre">sample_n]}</span></code>. Appends the dictionary of settings. Automatically saves the resulting dictionary in a .json format.</p>
</div></blockquote>
<blockquote>
<div><p><strong>Parameters:</strong></p>
<ul class="simple">
<li><p><strong>samples_path</strong> (str) - Path to the .hdf5 <code class="docutils literal notranslate"><span class="pre">emcee</span></code> backend.</p></li>
<li><p><strong>identifier</strong> (str) - Identifier used for the calibration.</p></li>
<li><p><strong>discard</strong> (int) - optional - Number of samples to discard at the start of the Markov chain.</p></li>
<li><p><strong>thin</strong> (int) - optional - Thinning ratio of the Markov chain.</p></li>
<li><p><strong>run_date</strong> (datetime) - optional - Date of calibration.</p></li>
</ul>
</div></blockquote>
<p>Samples path, identifier and run_date are combined to find the right .hdf5 <code class="docutils literal notranslate"><span class="pre">emcee</span></code> backend and the <code class="docutils literal notranslate"><span class="pre">.json</span></code> containing the settings.</p>
<blockquote>
<div><p><strong>Returns:</strong></p>
<ul class="simple">
<li><p><strong>samples_dict</strong> (dict) - Dictionary containing the discarded and thinned MCMC samples and settings.</p></li>
</ul>
</div></blockquote>
</section>
<section id="utils-py">
<h2>utils.py<a class="headerlink" href="#utils-py" title="Permalink to this heading">¶</a></h2>
<p><strong><em>function</em> add_poisson_noise(output)</strong></p>
<blockquote>
<div><p>Replace every value x in a simulation output with a realization from a Poisson distribution with expectation value x</p>
</div></blockquote>
<blockquote>
<div><p><strong>Parameters:</strong></p>
<ul class="simple">
<li><p><strong>output</strong> (xarray.Dataset) - Simulation output (obtained using the <code class="docutils literal notranslate"><span class="pre">sim()</span></code> function of <code class="docutils literal notranslate"><span class="pre">ODEModel</span></code> or <code class="docutils literal notranslate"><span class="pre">SDEModel</span></code>).</p></li>
</ul>
</div></blockquote>
<blockquote>
<div><p><strong>Returns:</strong></p>
<ul class="simple">
<li><p><strong>output</strong> (xarray.Dataset) - Simulation output</p></li>
</ul>
</div></blockquote>
<p><strong><em>function</em> add_gaussian_noise(output, sigma, relative=True)</strong></p>
<blockquote>
<div><p>Replace every value x in a simulation output with a realization from a normal distribution with average x and standard deviation <code class="docutils literal notranslate"><span class="pre">sigma</span></code> (relative=False) or x*<code class="docutils literal notranslate"><span class="pre">sigma</span></code> (relative=True)</p>
</div></blockquote>
<blockquote>
<div><p><strong>Parameters:</strong></p>
<ul class="simple">
<li><p><strong>output</strong> (xarray.Dataset) - Simulation output (obtained using the <code class="docutils literal notranslate"><span class="pre">sim()</span></code> function of <code class="docutils literal notranslate"><span class="pre">ODEModel</span></code> or <code class="docutils literal notranslate"><span class="pre">SDEModel</span></code>).</p></li>
<li><p><strong>sigma</strong> (float) - Standard deviation. Must be larger than or equal to 0.</p></li>
<li><p><strong>relative</strong> (bool) - Add noise relative to magnitude of simulation output.</p></li>
</ul>
</div></blockquote>
<blockquote>
<div><p><strong>Returns:</strong></p>
<ul class="simple">
<li><p><strong>output</strong> (xarray.Dataset) - Simulation output</p></li>
</ul>
</div></blockquote>
<p><strong><em>function</em> add_negative_binomial_noise(output, alpha)</strong></p>
<blockquote>
<div><p>Replace every value x in a simulation output with a realization from a negative binomial distribution with expectation value x and overdispersion <code class="docutils literal notranslate"><span class="pre">alpha</span></code></p>
</div></blockquote>
<blockquote>
<div><p><strong>Parameters:</strong></p>
<ul class="simple">
<li><p><strong>output</strong> (xarray.Dataset) - Simulation output (obtained using the <code class="docutils literal notranslate"><span class="pre">sim()</span></code> function of <code class="docutils literal notranslate"><span class="pre">ODEModel</span></code> or <code class="docutils literal notranslate"><span class="pre">SDEModel</span></code>).</p></li>
<li><p><strong>alpha</strong> (float) - Overdispersion factor. Must be larger than or equal to 0. Reduces to Poisson noise for alpha –&gt; 0.</p></li>
</ul>
</div></blockquote>
<blockquote>
<div><p><strong>Returns:</strong></p>
<ul class="simple">
<li><p><strong>output</strong> (xarray.Dataset) - Simulation output</p></li>
</ul>
</div></blockquote>
<p><strong><em>function</em> assign_theta(param_dict, parameter_names, thetas)</strong></p>
<blockquote>
<div><p>A function to assign a vector containing estimates of model parameters to the model parameters dictionary</p>
</div></blockquote>
<blockquote>
<div><p><strong>Parameters:</strong></p>
<ul class="simple">
<li><p><strong>param_dict</strong> (dict) - Model parameters dictionary</p></li>
<li><p><strong>parameter_names</strong> (list) - Names of model parameters estimated using PSO</p></li>
<li><p><strong>thetas</strong> (list or 1D np.ndarray) - A list with values of model parameters. Values ordermust correspond to the order of <code class="docutils literal notranslate"><span class="pre">parameter_names</span></code></p></li>
</ul>
</div></blockquote>
<blockquote>
<div><p><strong>Returns:</strong></p>
<ul class="simple">
<li><p><strong>warmup</strong> (float) - Offset between simulation start and start of data collection. Because ‘warmup’ does not reside in the model parameters dictionary, this argument is only returned if ‘warmup’ is in the parameter name list ‘pars’</p></li>
<li><p><strong>param_dict</strong> (dict) - Model parameters dictionary with values of parameters <code class="docutils literal notranslate"><span class="pre">parameter_names</span></code> set to the values listed in <code class="docutils literal notranslate"><span class="pre">thetas</span></code></p></li>
</ul>
</div></blockquote>
<p><strong><em>function</em> variance_analysis(data, resample_frequency)</strong></p>
<blockquote>
<div><p>A function to analyze the relationship between the variance and the mean in a timeseries of data, usefull when no measure of error is available.</p>
</div></blockquote>
<blockquote>
<div><p>The timeseries is binned into sets of length <code class="docutils literal notranslate"><span class="pre">resample_frequency</span></code>. The mean and variance of the datapoints within each bin are estimated. Several statistical models are then fitted to the relationship between the mean and variance. The statistical models are: Gaussian (<span class="math notranslate nohighlight">\(\sigma^2 = c\)</span>), Poisson (<span class="math notranslate nohighlight">\(\sigma^2 = \mu\)</span>), Quasi-poisson (<span class="math notranslate nohighlight">\(\sigma^2 = \alpha \mu\)</span>), Negative Binomial (<span class="math notranslate nohighlight">\(\sigma^2 = \mu + \alpha \mu^2\)</span>)</p>
</div></blockquote>
<blockquote>
<div><p><strong>Parameters:</strong></p>
<ul class="simple">
<li><p><strong>data</strong> (pd.Series or pd.DataFrame) - Timeseries of data to be analyzed. The series must have a pd.Timestamp index labeled ‘date’ for the time dimension. Additionally, this function supports the addition of one more dimension (f.i. space) using a pd.Multiindex.</p></li>
<li><p><strong>resample_frequency</strong> (str) - The resample frequency determines the number of days in each bin. We recommend varying this parameter before drawing conclusions. Valid options are: ‘W’: weekly, ‘2W’: biweekly, ‘M’: monthly, etc. <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/timeseries.html#offset-aliases">Consult the pandas docs</a>.</p></li>
</ul>
</div></blockquote>
<blockquote>
<div><p><strong>Returns:</strong></p>
<ul class="simple">
<li><p><strong>result</strong> (pd.Dataframe) - Contains the estimated parameter(s) and the Akaike Information Criterion (AIC) of the fitted statistical model. If two index levels are present (thus ‘date’ and ‘other index level’), the result pd.Dataframe contains the result stratified per ‘other index level’.</p></li>
<li><p><strong>ax</strong> (matplotlib.pyplot axis object) - Contains a plot of the estimated mean versus variance, togheter with the fitted statistical models. The best-fitting model is highlighted.</p></li>
</ul>
</div></blockquote>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="models.html" class="btn btn-neutral float-left" title="Models" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="speedup.html" class="btn btn-neutral float-right" title="Speeding up models" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Tijs Alleman.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>