

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>An stochastic jump process model for the 2017-2018 Influenza Season in Belgium &mdash; pySODM  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />

  
      <script src="_static/documentation_options.js?v=5929fcd5"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Additional references" href="references.html" />
    <link rel="prev" title="A model for the enzymatic esterification of D-glucose and Lauric acid in a continuous-flow reactor" href="enzyme_kinetics.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            pySODM
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="workflow.html">Modeling and calibration workflow</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Case studies</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="enzyme_kinetics.html">Enzyme kinetics</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Influenza 2017-2018</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#data">Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#model-dynamics-equations-and-parameters">Model dynamics, equations and parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#coding-it-up">Coding it up</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-model">The model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#social-contact-function">Social contact function</a></li>
<li class="toctree-l3"><a class="reference internal" href="#initializing-the-model">Initializing the model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#calibration">Calibration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#results-and-discussion">Results and discussion</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="references.html">Additional references</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="models.html">Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="optimization.html">Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="speedup.html">Speeding up models</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="start_to_collaborate.html">Start to collaborate</a></li>
<li class="toctree-l1"><a class="reference internal" href="guidelines.html">Contribution guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="git_workflow.html">Git workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">pySODM</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">An stochastic jump process model for the 2017-2018 Influenza Season in Belgium</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/influenza_1718.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="an-stochastic-jump-process-model-for-the-2017-2018-influenza-season-in-belgium">
<h1>An stochastic jump process model for the 2017-2018 Influenza Season in Belgium<a class="headerlink" href="#an-stochastic-jump-process-model-for-the-2017-2018-influenza-season-in-belgium" title="Link to this heading">¶</a></h1>
<p>This tutorial is showcased in our <a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S1877750323002089">software paper</a>.</p>
<p>We’ll set up a simple stochastic model for Influenza in Belgium. First, we’ll expand the dynamics of the <a class="reference internal" href="workflow.html"><span class="std std-doc">simple SIR model</span></a> to account for additional disease charateristics of Influenza, and we’ll use the concept of <em>dimensions</em> to include four age groups in our model (called ‘age strata’). Opposed to the simple SIR tutorial, where changes in the number of social contacts were not considered, we’ll demonstrate how to use a <em>time-dependent parameter function</em> to include the effects of school closures during school holidays in our Influenza model. Finally, we’ll calibrate two of the model’s parameters to incrementally larger sets of incidence data and asses how the goodness-of-fit evolves with the amount of knowledge at our disposal. One of the calibrated model parameters will be a 1D vector, pySODM allows users to easily calibrate n-dimensional model parameters.</p>
<p>This tutorial introduces the following concepts,</p>
<ol class="arabic simple">
<li><p>Building a stochastic model and simulate it with Gillespie’s Tau-Leaping method</p></li>
<li><p>Extending an SIR model with age strata and using a social contact matrix</p></li>
<li><p>Calibrating an n-D model parameter to an n-D dataset</p></li>
</ol>
<p>This tutorial can be replicated by running</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>calibration.py
</pre></div>
</div>
<p>located in <code class="docutils literal notranslate"><span class="pre">~/tutorials/influenza_1718/</span></code>. An environment containing the dependencies needed to run this tutorial is provided in <code class="docutils literal notranslate"><span class="pre">~/tutorial_env.yml</span></code>.</p>
<section id="data">
<h2>Data<a class="headerlink" href="#data" title="Link to this heading">¶</a></h2>
<p>Data on the weekly incidence of visits to General Practictioners (GP) for Influenza-like illness (ILI) are made publically available by the Belgian Scientific Institute of Public Health (Sciensano). These data were retrieved from the “End of season” report on Influenza in Belgium (see <code class="docutils literal notranslate"><span class="pre">data/raw/Influenza</span> <span class="pre">2017-2018</span> <span class="pre">End</span> <span class="pre">of</span> <span class="pre">Season_NL.pdf</span></code>). Using <a class="reference external" href="https://automeris.io/WebPlotDigitizer/">Webplotdigitizer</a>, the weekly number of GP visits in the different age groups were extracted (see <code class="docutils literal notranslate"><span class="pre">data/raw/ILI_weekly_1718.csv</span></code>). Then, the script <code class="docutils literal notranslate"><span class="pre">data_conversion.py</span></code> was used to convert the <em>raw</em> weekly incidence of Influenza cases in Belgium (per 100K inhabitats) during the 2017-2018 Influenza season into a better suited format. The week numbers in the raw dataset were replaced with the date of that week’s Thursday, as an approximation of the midpoint of the week. Further, the number of GP visits per 100K inhabitants was converted to the absolute number of GP visits. The formatted data are located in <code class="docutils literal notranslate"><span class="pre">data/interim/ILI_weekly_100K.csv</span></code> and <code class="docutils literal notranslate"><span class="pre">data/interim/ILI_weekly_100K.csv</span></code>.</p>
<p><img alt="data" src="_images/data.png" /></p>
<p>The absolute weekly number of GP visits data are loaded in our calibration script <code class="docutils literal notranslate"><span class="pre">~/tutorials/influenza_1718/calibration.py</span></code> as a <code class="docutils literal notranslate"><span class="pre">pd.DataFrame</span></code> with a <code class="docutils literal notranslate"><span class="pre">pd.Multiindex</span></code>. The weekly number of GP visits is divided by seven to approximate the daily incidence at the week’s midpoint (which we’ll use to calibrate our model). The <code class="docutils literal notranslate"><span class="pre">time</span></code>/<code class="docutils literal notranslate"><span class="pre">date</span></code> axis in the <code class="docutils literal notranslate"><span class="pre">pd.DataFrame</span></code> is obligatory. The other index names and values are the same as the model’s dimensions and coordinates. In this way, pySODM recognizes how model prediction and dataset must be aligned.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>date<span class="w">        </span>age_group
<span class="m">2017</span>-12-01<span class="w">  </span><span class="o">(</span><span class="m">0</span>,<span class="w"> </span><span class="m">5</span><span class="o">]</span><span class="w">        </span><span class="m">15</span>.727305
<span class="w">            </span><span class="o">(</span><span class="m">5</span>,<span class="w"> </span><span class="m">15</span><span class="o">]</span><span class="w">       </span><span class="m">13</span>.240385
<span class="w">            </span><span class="o">(</span><span class="m">15</span>,<span class="w"> </span><span class="m">65</span><span class="o">]</span><span class="w">     </span><span class="m">407</span>.778693
<span class="w">            </span><span class="o">(</span><span class="m">65</span>,<span class="w"> </span><span class="m">120</span><span class="o">]</span><span class="w">     </span><span class="m">32</span>.379271
<span class="w">                            </span>...<span class="w">    </span>
<span class="m">2018</span>-05-11<span class="w">  </span><span class="o">(</span><span class="m">0</span>,<span class="w"> </span><span class="m">5</span><span class="o">]</span><span class="w">         </span><span class="m">0</span>.000000
<span class="w">            </span><span class="o">(</span><span class="m">5</span>,<span class="w"> </span><span class="m">15</span><span class="o">]</span><span class="w">        </span><span class="m">0</span>.000000
<span class="w">            </span><span class="o">(</span><span class="m">15</span>,<span class="w"> </span><span class="m">65</span><span class="o">]</span><span class="w">       </span><span class="m">0</span>.000000
<span class="w">            </span><span class="o">(</span><span class="m">65</span>,<span class="w"> </span><span class="m">120</span><span class="o">]</span><span class="w">      </span><span class="m">0</span>.000000
Name:<span class="w"> </span>CASES,<span class="w"> </span>Length:<span class="w"> </span><span class="m">96</span>,<span class="w"> </span>dtype:<span class="w"> </span>float64
</pre></div>
</div>
<blockquote>
<div><p><strong>NOTE</strong> If we’d stratify our model further to include spatial patches, we could still calibrate the model to the DataFrame above. pySODM would, by default, sum over the model’s spatial axis to align the prediction with the data. This default summation over model axes not present in the data can be replaced with a user-defined function, see input argument <code class="docutils literal notranslate"><span class="pre">aggregation_function</span></code> of <code class="docutils literal notranslate"><span class="pre">log_posterior_distribution</span></code>.</p>
</div></blockquote>
</section>
<section id="model-dynamics-equations-and-parameters">
<h2>Model dynamics, equations and parameters<a class="headerlink" href="#model-dynamics-equations-and-parameters" title="Link to this heading">¶</a></h2>
<p>We extend the classical Susceptible-Infectious-Recovered or SIR model of Kermack and McKendrick by making two changes to the compartmental structure. First, an exposed state (<span class="math notranslate nohighlight">\(E\)</span>) is added to account for the latent phase between the moment of infection and the onset of infectiousness. Second, the infectious state (<span class="math notranslate nohighlight">\(I\)</span>) is split in three parts. Individuals may experience infectiousness prior to symptom onset (<span class="math notranslate nohighlight">\(I_{\text{pre}}\)</span>). Then, after the onset of symptoms, not all infectious individuals will visit a GP and thus these individuals will not end up in the dataset. We include a state for individuals who are infectious but remain undetected (<span class="math notranslate nohighlight">\(I_{\text{ud}}\)</span>), and, we include a state for individuals who are infectious and go to a GP (<span class="math notranslate nohighlight">\(I_{\text{d}}\)</span>). All infectious individuals can transmit the disease. However, detected infectious individuals are assumed to only make 22% of the regular number of social contacts, corresponding to the fraction of contacts made at home.</p>
<img src="./_static/figs/influenza_1718/influenza_flowchart.png" width="600" />
<p>We’ll simulate these dynamics stochastically with Gillespie’s Tau-Leaping method. Instead of defining a differential equation for every model state, we need to define the rates of the six possible transitionings in the system,</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{cases}
T^i &amp;=&amp; S^i + E^i + I_{\text{pre}}^i + I_{\text{ud}}^i + I_{\text{d}}^i + R^i, \nonumber\\
\mathcal{R}(S \rightarrow E)^i &amp;=&amp; \beta \sum_j N^{ij}(t) \dfrac{(I_{\text{pre}}^j + I_{\text{ud}}^j + 0.22 I_{\text{d}}^j)}{T^j}, \nonumber\\
\mathcal{R}(E \rightarrow I_{\text{pre}})^i &amp;=&amp; 1/\alpha, \nonumber \\
\mathcal{R}(I_{\text{pre}} \rightarrow I_{\text{ud}})^i &amp;=&amp; f_{\text{ud}}^i/\gamma, \nonumber \\
\mathcal{R}(I_{\text{pre}} \rightarrow I_{\text{d}})^i &amp;=&amp; (1-f_{\text{ud}}^i)/\gamma, \nonumber \\
\mathcal{R}(I_{\text{ud}} \rightarrow R)^i &amp;=&amp; 1/\delta, \nonumber \\
\mathcal{R}(I_d \rightarrow R)^i &amp;=&amp; 1/\delta, 
\end{cases}\end{split}\]</div>
<p>where the subscript <span class="math notranslate nohighlight">\(i\)</span> refers to the model’s age groups: <span class="math notranslate nohighlight">\([0,5(, [5,15(, [15,65(,\text{ and } [65,120(\)</span> years old. <span class="math notranslate nohighlight">\(T\)</span> denotes the total population, <span class="math notranslate nohighlight">\(S\)</span> denotes the number of individuals susceptible to the disease, <span class="math notranslate nohighlight">\(E\)</span> denotes the number of exposed individuals, <span class="math notranslate nohighlight">\(I_{\text{pre}}\)</span> denotes the number of presymptomatic infectious individuals, <span class="math notranslate nohighlight">\(I_{\text{ud}}\)</span> denotes the number of infectious but undetected individuals and <span class="math notranslate nohighlight">\(I_{\text{d}}\)</span> denotes the number of infectious individuals who visit the GP, <span class="math notranslate nohighlight">\(R\)</span> denotes the number of removed individuals, either through death or recovery. The model has six parameters,</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\alpha\)</span>: Duration of the latent phase, equal to one day.</p></li>
<li><p><span class="math notranslate nohighlight">\(\beta\)</span> : Per-contact chance of Influenza transmission. Calibrated.</p></li>
<li><p><span class="math notranslate nohighlight">\(\gamma\)</span> : Duration of pre-symptomatic infectiousness, equal to one day.</p></li>
<li><p><span class="math notranslate nohighlight">\(\delta\)</span> : Duration of infectiousness, equal to one day.</p></li>
<li><p><span class="math notranslate nohighlight">\(N^{ij}\)</span> : Square origin-destination matrix containing the number of social contacts in age group <span class="math notranslate nohighlight">\(i\)</span> with individuals from age group <span class="math notranslate nohighlight">\(j\)</span>. Extracted from <a class="reference external" href="http://www.socialcontactdata.org/socrates/">Socrates</a>. Dataset: Hoang, Belgium, 2010. Physical contacts with a duration of 15+ minutes only. Integrated with contact duration.</p></li>
<li><p><span class="math notranslate nohighlight">\(f_{\text{ud}}^i\)</span> : Age-stratified fraction of undetected cases. Calibrated.</p></li>
</ul>
<p>Assuming the aforementioned transition rates from a generic state <span class="math notranslate nohighlight">\(X\)</span> to a state <span class="math notranslate nohighlight">\(Y\)</span> in age group <span class="math notranslate nohighlight">\(i\)</span>, denoted <span class="math notranslate nohighlight">\(\mathcal{R}(X \rightarrow Y)^i\)</span>, are constant over the interval <span class="math notranslate nohighlight">\([t,t+\tau]\)</span>, the probability of a transition from a generic state <span class="math notranslate nohighlight">\(X\)</span> to <span class="math notranslate nohighlight">\(Y\)</span> happening in the interval <span class="math notranslate nohighlight">\([t,t+\tau]\)</span> is exponentially distributed, mathematically,</p>
<div class="math notranslate nohighlight">
\[\mathcal{P}(X \rightarrow Y)^i = 1 - e^{- \tau*\mathcal{R}(X \rightarrow Y)^i}.\]</div>
<p>The corresponding number of transitions <span class="math notranslate nohighlight">\(X \rightarrow Y\)</span> in age class <span class="math notranslate nohighlight">\(i\)</span> and between time <span class="math notranslate nohighlight">\(t\)</span> and <span class="math notranslate nohighlight">\(t + \tau\)</span> are then generated by drawing from a binomial distribution,</p>
<div class="math notranslate nohighlight">
\[\mathcal{N}(X \rightarrow Y)^i = Binom(\mathcal{P}(X \rightarrow Y)^i, X^i).\]</div>
<p>The number of individuals in each of the compartments at time <span class="math notranslate nohighlight">\(t + \tau\)</span> is then given by,</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{cases}
S^i(t+\tau) &amp;=&amp; S^i(t) - \mathcal{N}(S \rightarrow E)^i, \nonumber \\
E^i(t+\tau) &amp;=&amp; E^i(t) + \mathcal{N}(S \rightarrow E)^i - \mathcal{N}(E \rightarrow I_{\text{pre}})^i, \nonumber\\
I_{\text{pre}}^i(t+\tau) &amp;=&amp; I_{\text{pre}}^i(t) + \mathcal{N}(E \rightarrow I_{\text{pre}})^i - \mathcal{N}(I_{\text{pre}} \rightarrow I_{\text{ud}})^i - \mathcal{N}(I_{\text{pre}} \rightarrow I_{\text{d}})^i, \nonumber\\
I_{\text{ud}}^i(t+\tau) &amp;=&amp; I_{\text{ud}}^i(t) + \mathcal{N}(I_{\text{pre}} \rightarrow I_{\text{ud}})^i - \mathcal{N}(I_{\text{ud}} \rightarrow R)^i, \nonumber \\
I_{\text{d}}^i(t+\tau) &amp;=&amp; I_{\text{d}}^i(t) + \mathcal{N}(I_{\text{pre}} \rightarrow I_{\text{d}})^i - \mathcal{N}(I_d \rightarrow R)^i, \nonumber \\
R^i(t+\tau) &amp;=&amp; R^i(t) + \mathcal{N}(I_{\text{ud}} \rightarrow R)^i + \mathcal{N}(I_\text{d} \rightarrow R)^i.
\end{cases}\end{split}\]</div>
<p>The daily number of GP visits (incidence) is computed as,</p>
<div class="math notranslate nohighlight">
\[\begin{equation}
I_{\text{d, inc}}^i(t+\tau) = \mathcal{N}(I_{\text{pre}} \rightarrow I_{\text{d}})^i.
\end{equation}\]</div>
<p>We’ll match this state to the dataset. The basic reproduction number in age group <span class="math notranslate nohighlight">\(i\)</span> of the equivalent deterministic model can be computed using the next-generation matrix approach introduced by Diekmann et al.,</p>
<div class="math notranslate nohighlight">
\[\begin{equation}
R_0^i = \beta \big(\gamma + f_{\text{ud}}^i \delta + 0.22 (1-f_{\text{ud}})\delta\big) \sum_j N^{ij}, 
\end{equation}\]</div>
<p>and the population basic reproduction number is computed as the weighted average over all age groups using demographic data.</p>
</section>
<section id="coding-it-up">
<h2>Coding it up<a class="headerlink" href="#coding-it-up" title="Link to this heading">¶</a></h2>
<section id="the-model">
<h3>The model<a class="headerlink" href="#the-model" title="Link to this heading">¶</a></h3>
<p>Opposed to ODE models, where the user had to define an <code class="docutils literal notranslate"><span class="pre">integrate()</span></code> function to compute the values of the derivatives at time <span class="math notranslate nohighlight">\(t\)</span>, the user will have to define <a class="reference internal" href="models.html"><span class="std std-doc">two functions</span></a> to setup an stochastic jump process model: 1) A function to compute the rates at time <span class="math notranslate nohighlight">\(t\)</span> named <code class="docutils literal notranslate"><span class="pre">compute_rates()</span></code>, and 2) A function to compute the values of the model states at time <span class="math notranslate nohighlight">\(t+\tau\)</span> named <code class="docutils literal notranslate"><span class="pre">apply_transitionings()</span></code>. As we did in the <a class="reference internal" href="enzyme_kinetics.html"><span class="std std-doc">packed-bed continuous flow reactor</span></a> tutorial, we’ll stratifiy the model into age groups by specifying a variable <code class="docutils literal notranslate"><span class="pre">dimensions</span></code> in our model declaration and we’ll implement the parameter <span class="math notranslate nohighlight">\(f_a\)</span> as a stratified parameter by specifying a variable <code class="docutils literal notranslate"><span class="pre">stratified_parameters</span></code>. <strong>As dimension name, we use the same name as the age dimension in the dataset: <code class="docutils literal notranslate"><span class="pre">'age_group'</span></code>. The coordinates of the dimension will be defined later when the model is initialized, we’ll have to use the same coordinates as the dataset.</strong> As in the <a class="reference internal" href="enzyme_kinetics.html"><span class="std std-doc">enzyme kinetics tutorial</span></a>, we’ll group our model in a file called <code class="docutils literal notranslate"><span class="pre">models.py</span></code> to reduce the complexity of our calibration script. We introduce one additional state in the model, the incidence of new detected cases, <code class="docutils literal notranslate"><span class="pre">I_m_inc</span></code>, which we’ll use this state to match our data to.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pySODM.models.base</span> <span class="kn">import</span> <span class="n">JumpProcess</span>

<span class="k">class</span> <span class="nc">JumpProcess_influenza_model</span><span class="p">(</span><span class="n">JumpProcess</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple stochastic SEIR model for influenza with undetected carriers</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">states</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">,</span><span class="s1">&#39;E&#39;</span><span class="p">,</span><span class="s1">&#39;Ip&#39;</span><span class="p">,</span><span class="s1">&#39;Iud&#39;</span><span class="p">,</span><span class="s1">&#39;Id&#39;</span><span class="p">,</span><span class="s1">&#39;R&#39;</span><span class="p">,</span><span class="s1">&#39;Im_inc&#39;</span><span class="p">]</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;gamma&#39;</span><span class="p">,</span> <span class="s1">&#39;delta&#39;</span><span class="p">,</span><span class="s1">&#39;N&#39;</span><span class="p">]</span>
    <span class="n">stratified_parameters</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;f_ud&#39;</span><span class="p">]</span>
    <span class="n">dimensions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;age_group&#39;</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">compute_rates</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">Ip</span><span class="p">,</span> <span class="n">Iud</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">Im_inc</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">f_ud</span><span class="p">):</span>
        
        <span class="c1"># Calculate total population</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">S</span><span class="o">+</span><span class="n">E</span><span class="o">+</span><span class="n">Ip</span><span class="o">+</span><span class="n">Iud</span><span class="o">+</span><span class="n">Id</span><span class="o">+</span><span class="n">R</span>
        <span class="c1"># Compute rates per model state</span>
        <span class="n">rates</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">beta</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="p">(</span><span class="n">Ip</span><span class="o">+</span><span class="n">Iud</span><span class="o">+</span><span class="mf">0.22</span><span class="o">*</span><span class="n">Id</span><span class="p">)</span><span class="o">/</span><span class="n">T</span><span class="p">),],</span>
            <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="n">alpha</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">shape</span><span class="p">),],</span>
            <span class="s1">&#39;Ip&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">f_ud</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">gamma</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">f_ud</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">gamma</span><span class="p">)],</span>
            <span class="s1">&#39;Iud&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">1</span><span class="o">/</span><span class="n">delta</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">shape</span><span class="p">),],</span>
            <span class="s1">&#39;Id&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">1</span><span class="o">/</span><span class="n">delta</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">shape</span><span class="p">),],</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">rates</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">apply_transitionings</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">transitionings</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">Ip</span><span class="p">,</span> <span class="n">Iud</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">Im_inc</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">f_ud</span><span class="p">):</span>

        <span class="n">S_new</span>  <span class="o">=</span> <span class="n">S</span> <span class="o">-</span> <span class="n">transitionings</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">E_new</span> <span class="o">=</span> <span class="n">E</span> <span class="o">+</span> <span class="n">transitionings</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">transitionings</span><span class="p">[</span><span class="s1">&#39;E&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Ip_new</span> <span class="o">=</span> <span class="n">Ip</span> <span class="o">+</span> <span class="n">transitionings</span><span class="p">[</span><span class="s1">&#39;E&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">transitionings</span><span class="p">[</span><span class="s1">&#39;Ip&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">transitionings</span><span class="p">[</span><span class="s1">&#39;Ip&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">Iud_new</span> <span class="o">=</span> <span class="n">Iud</span> <span class="o">+</span> <span class="n">transitionings</span><span class="p">[</span><span class="s1">&#39;Ip&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">transitionings</span><span class="p">[</span><span class="s1">&#39;Iud&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Id_new</span> <span class="o">=</span> <span class="n">Id</span> <span class="o">+</span> <span class="n">transitionings</span><span class="p">[</span><span class="s1">&#39;Ip&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">transitionings</span><span class="p">[</span><span class="s1">&#39;Id&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">R_new</span> <span class="o">=</span> <span class="n">R</span> <span class="o">+</span> <span class="n">transitionings</span><span class="p">[</span><span class="s1">&#39;Iud&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">transitionings</span><span class="p">[</span><span class="s1">&#39;Id&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Im_inc_new</span> <span class="o">=</span> <span class="n">transitionings</span><span class="p">[</span><span class="s1">&#39;Ip&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">S_new</span><span class="p">,</span> <span class="n">E_new</span><span class="p">,</span> <span class="n">Ip_new</span><span class="p">,</span> <span class="n">Iud_new</span><span class="p">,</span> <span class="n">Id_new</span><span class="p">,</span> <span class="n">R_new</span><span class="p">,</span> <span class="n">Im_inc_new</span>
</pre></div>
</div>
<p>There are some formatting requirements to <code class="docutils literal notranslate"><span class="pre">compute_rates()</span></code> and <code class="docutils literal notranslate"><span class="pre">apply_transitionings()</span></code>, which are listed in the <a class="reference internal" href="models.html"><span class="std std-doc">JumpProcess documentation</span></a>.</p>
<p>The actual drawing of the transitionings is abstracted away from the user in the <code class="docutils literal notranslate"><span class="pre">JumpProcess</span></code> class. Two stochastic simulation algorithms are currently available. In this tutorial, we’ll use the Tau-Leaping method, where the value of <code class="docutils literal notranslate"><span class="pre">tau</span></code> is fixed and the number of transitionings in the interval <code class="docutils literal notranslate"><span class="pre">t</span></code> and <code class="docutils literal notranslate"><span class="pre">t</span> <span class="pre">+</span> <span class="pre">\tau</span></code> are drawn from a binomial distribution. This method is an approximation of the Stochastic Simulation Algorithm (SSA), where the time until the first transitioning <code class="docutils literal notranslate"><span class="pre">tau</span></code> is computed and only one transitioning can happen at every simulation step. However, as we aim to simulate a large number of individuals (11 million individuals), the time between transitionings becomes very small and the SSA becomes computationally too demanding. Good values for <code class="docutils literal notranslate"><span class="pre">tau</span></code> are typically found by balancing the use of computational resources against numerical stability.</p>
</section>
<section id="social-contact-function">
<h3>Social contact function<a class="headerlink" href="#social-contact-function" title="Link to this heading">¶</a></h3>
<p>The number of work and school contacts tends to change during school holidays and this has an effect on Influenza spread. We’ll thus use a <em>time-dependent parameter function</em> to vary the number of social contacts <span class="math notranslate nohighlight">\(\mathbf{N}\)</span> during the simulation. We’ll wrap our <code class="docutils literal notranslate"><span class="pre">contact_function()</span></code> in a class for the sake of user friendliness. The initialization of the class is used to store the contact matrices inside the dictionary <span class="math notranslate nohighlight">\(\mathbf{N}\)</span>. The callable function <code class="docutils literal notranslate"><span class="pre">__call__</span></code> is used to return the right contact matrix. The <code class="docutils literal notranslate"><span class="pre">contact_function()</span></code> is the actual pySODM-compatible <em>time-dependent parameter function</em>, which implements the social policies. We’ll add our TDPF to the <code class="docutils literal notranslate"><span class="pre">models.py</span></code> script.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">make_contact_matrix_function</span><span class="p">():</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the class by storing the dictionary of contacts</span>

<span class="sd">        Input</span>
<span class="sd">        =====</span>

<span class="sd">        N: dict</span>
<span class="sd">            Dictionary holding the contact matrices.</span>
<span class="sd">            Contains two levels. 1) holiday/no_holiday, 2) week/weekend</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">N</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">holiday</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A function to choose the appropriate contact matrix (holiday? weekend?)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Choose between holiday/no_holiday</span>
        <span class="k">if</span> <span class="n">holiday</span><span class="p">:</span>
            <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="s1">&#39;holiday&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="s1">&#39;no_holiday&#39;</span><span class="p">]</span>
        
        <span class="c1"># Choose between weekday and weekendday</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">t</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">N</span><span class="p">[</span><span class="s1">&#39;weekend&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">N</span><span class="p">[</span><span class="s1">&#39;week&#39;</span><span class="p">]</span>

    <span class="c1"># Define a pySODM compatible wrapper with the social policies</span>
    <span class="k">def</span> <span class="nf">contact_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A pySODM compatible wrapper containing the social policies</span>

<span class="sd">        Input</span>
<span class="sd">        =====</span>

<span class="sd">        t: timestamp</span>
<span class="sd">            Current simulated date</span>

<span class="sd">        states: dict</span>
<span class="sd">            Dictionary containing model states at current time</span>

<span class="sd">        param: dict</span>
<span class="sd">            Dictionary containing all model parameters</span>

<span class="sd">        Output</span>
<span class="sd">        ======</span>

<span class="sd">        N: np.ndarray (4x4)</span>
<span class="sd">            Matrix of social contacts at time `t`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2017-10-30&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="c1"># Winter holiday</span>
        <span class="k">elif</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2017-10-30&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2017-11-05&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">holiday</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Winter holiday --&gt; Christmas holiday</span>
        <span class="k">elif</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2017-11-05&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2017-12-22&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>    
        <span class="c1"># Christmas holiday</span>
        <span class="k">elif</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2017-12-22&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2018-01-07&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">holiday</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Christmas holiday --&gt; Spring holiday</span>
        <span class="k">elif</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2018-01-07&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2018-02-12&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="c1">#Spring holiday</span>
        <span class="k">elif</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2018-02-12&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2018-02-18&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">holiday</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Spring holiday --&gt; Easter holiday</span>
        <span class="k">elif</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2018-02-18&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2018-04-02&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="c1"># Easter holiday</span>
        <span class="k">elif</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2018-04-02&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2018-04-15&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">holiday</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="initializing-the-model">
<h3>Initializing the model<a class="headerlink" href="#initializing-the-model" title="Link to this heading">¶</a></h3>
<p>Next, we’ll set the model up in our calibration script <code class="docutils literal notranslate"><span class="pre">~/tutorials/influenza_1718/calibration.py</span></code>. We load the model and social contact function from <code class="docutils literal notranslate"><span class="pre">models.py</span></code> and initialize the contact matrix function using the social contact matrices (hardcoded in the example). Then, as always, we define the model parameters, initial states (obtained analytically so the differentials are zero at <span class="math notranslate nohighlight">\(t=0\)</span>) and coordinates. <strong>The coordinates for dimension <code class="docutils literal notranslate"><span class="pre">age_groups</span></code> must be the same as the dataset: <code class="docutils literal notranslate"><span class="pre">pd.IntervalIndex.from_tuples([(0,5),(5,15),(15,65),(65,120)]</span></code></strong>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="c1"># Load model</span>
<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">JumpProcess_influenza_model</span> <span class="k">as</span> <span class="n">influenza_model</span>

<span class="c1"># Load TDPF</span>
<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">make_contact_matrix_function</span>

<span class="c1"># Hardcode the contact matrices</span>
<span class="n">N_noholiday_week</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">N_noholiday_weekend</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">N_holiday_week</span> <span class="o">=</span> <span class="o">...</span>

<span class="c1"># Construct a dictionary of contact matrices</span>
<span class="n">N</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;holiday&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;week&#39;</span><span class="p">:</span> <span class="n">N_holiday_week</span><span class="p">,</span> <span class="s1">&#39;weekend&#39;</span><span class="p">:</span> <span class="n">N_noholiday_weekend</span><span class="p">},</span>
    <span class="s1">&#39;no_holiday&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;week&#39;</span><span class="p">:</span> <span class="n">N_noholiday_week</span><span class="p">,</span> <span class="s1">&#39;weekend&#39;</span><span class="p">:</span> <span class="n">N_noholiday_weekend</span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Initialize contact function</span>
<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">make_contact_matrix_function</span>
<span class="n">contact_function</span> <span class="o">=</span> <span class="n">make_contact_matrix_function</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">.</span><span class="n">contact_function</span>

<span class="c1"># Define model parameters</span>
<span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">:</span> <span class="mf">0.0174</span><span class="p">,</span> <span class="s1">&#39;gamma&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;delta&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span><span class="s1">&#39;f_ud&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.64</span><span class="p">,</span> <span class="mf">0.905</span><span class="p">,</span> <span class="mf">0.60</span><span class="p">]),</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">[</span><span class="s1">&#39;holiday&#39;</span><span class="p">][</span><span class="s1">&#39;week&#39;</span><span class="p">]}</span>

<span class="c1"># Define initial condition</span>
<span class="n">init_states</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">initN</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
              <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">((</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;f_ud&#39;</span><span class="p">]))</span><span class="o">*</span><span class="n">df_influenza</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">start_calibration</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)])),</span>
              <span class="s1">&#39;Ip&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">((</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;f_ud&#39;</span><span class="p">]))</span><span class="o">*</span><span class="n">df_influenza</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">start_calibration</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)])),</span>
              <span class="s1">&#39;Iud&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">((</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;f_ud&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;f_ud&#39;</span><span class="p">]))</span><span class="o">*</span><span class="n">df_influenza</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">start_calibration</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)])),</span>
              <span class="s1">&#39;Id&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">df_influenza</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">start_calibration</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)])),</span>
              <span class="s1">&#39;Im_inc&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">df_influenza</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">start_calibration</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]))}</span>

<span class="c1"># Define model coordinates</span>
<span class="n">coordinates</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;age_group&#39;</span><span class="p">:</span> <span class="n">age_groups</span><span class="p">}</span>

<span class="c1"># Initialize model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">influenza_model</span><span class="p">(</span><span class="n">init_states</span><span class="p">,</span><span class="n">params</span><span class="p">,</span><span class="n">coordinates</span><span class="p">,</span><span class="n">time_dependent_parameters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="n">contact_function</span><span class="p">})</span>
</pre></div>
</div>
</section>
<section id="calibration">
<h3>Calibration<a class="headerlink" href="#calibration" title="Link to this heading">¶</a></h3>
<p>We aim to calibrate two model parameters: <span class="math notranslate nohighlight">\(\beta\)</span> and <span class="math notranslate nohighlight">\(\mathbf{f_{ud}}\)</span>. However, <span class="math notranslate nohighlight">\(\mathbf{f_{ud}}\)</span> consists of four elements <span class="math notranslate nohighlight">\(f_{ud}^i\)</span>, how does pySODM handle this?</p>
<p>As if nothing’s up,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="kn">from</span> <span class="nn">pySODM.optimization.objective_functions</span> <span class="kn">import</span> <span class="n">log_posterior_probability</span><span class="p">,</span> <span class="n">ll_negative_binomial</span>

    <span class="c1"># Define dataset</span>
    <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">df_influenza</span><span class="p">[</span><span class="n">start_date</span><span class="p">:</span><span class="n">end_calibration</span><span class="p">],</span> <span class="p">]</span>
    <span class="n">states</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Im_inc&quot;</span><span class="p">,]</span>
    <span class="n">log_likelihood_fnc</span> <span class="o">=</span> <span class="p">[</span><span class="n">ll_negative_binomial</span><span class="p">,]</span>
    <span class="n">log_likelihood_fnc_args</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="p">[</span><span class="mf">0.03</span><span class="p">,],]</span>

    <span class="c1"># Calibated parameters and bounds</span>
    <span class="n">pars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;f_ud&#39;</span><span class="p">]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">beta$&#39;</span><span class="p">,</span> <span class="s1">&#39;$f_</span><span class="si">{ud}</span><span class="s1">$&#39;</span><span class="p">]</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">1e-6</span><span class="p">,</span><span class="mf">0.06</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.99</span><span class="p">)]</span>

    <span class="c1"># Setup objective function (no priors --&gt; uniform priors based on bounds)</span>
    <span class="n">objective_function</span> <span class="o">=</span> <span class="n">log_posterior_probability</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">log_likelihood_fnc</span><span class="p">,</span> <span class="n">log_likelihood_fnc_args</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
</pre></div>
</div>
<p>In the example above, bounds and labels of <span class="math notranslate nohighlight">\(\mathbf{f_{ud}}\)</span> are automatically expanded to the right size when the log posterior probability function is initialized. However, I have retained the possibility of supplying a bound and label per element of <span class="math notranslate nohighlight">\(\mathbf{f_{ud}}\)</span>. Running the NM/PSO and MCMC optimizations happens in the same manner as the other tutorials.</p>
</section>
</section>
<section id="results-and-discussion">
<h2>Results and discussion<a class="headerlink" href="#results-and-discussion" title="Link to this heading">¶</a></h2>
<p>We’re now ready to generate our results, we’ll first calibrate the model using data up until January 1st, 2018. Then, we’ll increase the amount of available data until February 1st, 2018 and then March 1st, 2018, representing the moment right before, and right after, the peak incidence. Let’s first have a look at the sampled distributions of <span class="math notranslate nohighlight">\(\beta\)</span> and <span class="math notranslate nohighlight">\(\mathbf{f_{ud}}\)</span> on the largest dataset (ending March 1st, 2018).</p>
<p>The optimal values of the fraction of undetected cases <span class="math notranslate nohighlight">\(\mathbf{f_{ud}}\)</span> are: <code class="docutils literal notranslate"><span class="pre">f_ud</span> <span class="pre">=</span> <span class="pre">[0.01,</span> <span class="pre">0.64,</span> <span class="pre">0.90,</span> <span class="pre">0.60]</span></code>. The undetected fraction is thus very small in children aged five years and below, then increases to 90% in individuals aged 15 to 65 years old, and finally decreases to 60% in the senior population. The population average basic reproduction number was <span class="math notranslate nohighlight">\(R_0 = 1.95 (95~\%\ CI: 1.91-1.98)\)</span>.</p>
<p><img alt="corner_enddate_2018-03-01" src="_images/influenza_corner_March_1st.png" /></p>
<p>Next, we show, for every age group and for our three calibration datasets, the model trajectories plotted on top of the data. Considering how rudimentary this model is, even the predictions made on January 1st, 2018, one month and a half before the peak incidence, are reasonably accurate and can be informative to policymakers. It should be noted that the peak incidence in the adult age groups falls at least two weeks earlier than was the case in real life.</p>
<p>The results obtained using our simple model are encouraging but not yet sufficiently accurate to advice policy makers and GPs. To improve the accuracy of our simple model, we see two possibilities. First, by making the model spatially-explicit, we include more heterogeneity in the model rendering predicted epidemic peaks more broad under the same number of social contacts. Second, including vaccines could likely further improve this model’s accuracy by lowering the peak incidence in the elderly population, as vaccine uptake was found to increase significantly in individuals above fifty years old. Finally, the consistency of the obtained parameter estimates, as well as the accuracy of the calibration procedure should be demonstrated across multiple influenza seasons. However, this is out of the scope as the aim of this work is merely to highlight our code’s ability to speed up a modeling and simulation workflow.</p>
<p><strong>Calibration ending on January 1st, 2018</strong></p>
<p><img alt="fit_enddate_2018-01-01" src="_images/influenza_fit_January_1st.png" /></p>
<p><strong>Calibration ending on February 1st, 2018</strong></p>
<p><img alt="fit_enddate_2018-02-01" src="_images/influenza_fit_February_1st.png" /></p>
<p><strong>Calibration ending on March 1st, 2018</strong></p>
<p><img alt="fit_enddate_2018-03-01" src="_images/influenza_fit_March_1st.png" /></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="enzyme_kinetics.html" class="btn btn-neutral float-left" title="A model for the enzymatic esterification of D-glucose and Lauric acid in a continuous-flow reactor" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="references.html" class="btn btn-neutral float-right" title="Additional references" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Tijs Alleman.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>